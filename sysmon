#!/bin/bash

# SysMon - System Resource Monitor
# Version: 1.1.0

VERSION="1.1.0"
SCRIPT_NAME="sysmon"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_header() { echo -e "${CYAN}${BOLD}${1}${NC}"; }

show_usage() {
    cat << EOF
${BLUE}${BOLD}SysMon${NC} - System Resource Monitor v${VERSION}

${YELLOW}Usage:${NC}
    $SCRIPT_NAME [command] [options]

${YELLOW}Commands:${NC}
    (no command)             Dashboard view (default)
    process                  List all processes
    top                      Top resource consumers
    network                  Network connections
    disk                     Disk I/O and usage
    gpu                      GPU monitoring (NVIDIA/AMD/Intel)
    kill <pid>               Kill a process
    watch                    Live monitoring mode

${YELLOW}Options:${NC}
    -h, --help              Show this help
    -v, --version           Show version
    --no-color              Disable colors

${YELLOW}Examples:${NC}
    $SCRIPT_NAME
        → Show system dashboard

    $SCRIPT_NAME process
        → List all processes

    $SCRIPT_NAME top
        → Show top consumers

    $SCRIPT_NAME network
        → Show network activity

    $SCRIPT_NAME gpu
        → Monitor GPU usage

    $SCRIPT_NAME kill 1234
        → Kill process 1234

${YELLOW}Dashboard:${NC}
    Shows at a glance:
    • CPU usage
    • Memory usage
    • Disk usage
    • Network activity
    • Top processes
    • System load

EOF
}

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Get color based on percentage
get_color() {
    local percent=$1
    if [ "$percent" -ge 90 ]; then
        echo "$RED"
    elif [ "$percent" -ge 70 ]; then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

# Format bytes
format_bytes() {
    local bytes=$1
    if [ "$bytes" -lt 1024 ]; then
        echo "${bytes}B"
    elif [ "$bytes" -lt 1048576 ]; then
        echo "$((bytes / 1024))KB"
    elif [ "$bytes" -lt 1073741824 ]; then
        echo "$((bytes / 1048576))MB"
    else
        echo "$((bytes / 1073741824))GB"
    fi
}

# Get CPU usage
get_cpu_usage() {
    if command -v mpstat &> /dev/null; then
        mpstat 1 1 | awk '/Average/ {print 100 - $NF}'
    else
        top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}'
    fi
}

# Get memory usage
get_memory_usage() {
    free | grep Mem | awk '{printf "%.0f", ($3/$2) * 100.0}'
}

# Get memory details
get_memory_details() {
    free -h | grep Mem | awk '{print $3 "/" $2}'
}

# Get disk usage
get_disk_usage() {
    df -h / | awk 'NR==2 {print $5}' | sed 's/%//'
}

# Get disk details
get_disk_details() {
    df -h / | awk 'NR==2 {print $3 "/" $2}'
}

# Get system load
get_load_average() {
    uptime | awk -F'load average:' '{print $2}' | sed 's/^[ \t]*//'
}

# Get uptime
get_uptime() {
    uptime -p 2>/dev/null || uptime | awk -F'up ' '{print $2}' | awk -F',' '{print $1}'
}

# Detect GPU type
detect_gpu() {
    if command -v nvidia-smi &> /dev/null; then
        echo "nvidia"
    elif command -v radeontop &> /dev/null || [ -d /sys/class/drm ] && ls /sys/class/drm/card*/device/vendor 2>/dev/null | xargs cat 2>/dev/null | grep -q "0x1002"; then
        echo "amd"
    elif lspci 2>/dev/null | grep -i vga | grep -iq intel; then
        echo "intel"
    else
        echo "none"
    fi
}

# Get NVIDIA GPU info
get_nvidia_info() {
    if ! command -v nvidia-smi &> /dev/null; then
        return 1
    fi
    
    nvidia-smi --query-gpu=index,name,utilization.gpu,utilization.memory,memory.used,memory.total,temperature.gpu,power.draw,power.limit,fan.speed --format=csv,noheader,nounits 2>/dev/null
}

# Get AMD GPU info
get_amd_info() {
    local gpu_info=""
    local gpu_count=0
    
    # Try using rocm-smi first
    if command -v rocm-smi &> /dev/null; then
        rocm-smi --showuse --showmeminfo vram --showtemp --showpower 2>/dev/null
        return 0
    fi
    
    # Fallback to sysfs
    for card in /sys/class/drm/card*/device; do
        if [ -f "$card/vendor" ]; then
            local vendor=$(cat "$card/vendor" 2>/dev/null)
            if [ "$vendor" = "0x1002" ]; then
                local name=$(cat "$card/product_name" 2>/dev/null || echo "AMD GPU $gpu_count")
                local busy_percent=$(cat "$card/gpu_busy_percent" 2>/dev/null || echo "N/A")
                local temp=$(cat "$card/hwmon/hwmon*/temp1_input" 2>/dev/null | head -1)
                [ -n "$temp" ] && temp=$((temp / 1000)) || temp="N/A"
                
                echo "GPU $gpu_count: $name"
                echo "  Usage: ${busy_percent}%"
                echo "  Temp: ${temp}°C"
                echo ""
                gpu_count=$((gpu_count + 1))
            fi
        fi
    done
    
    [ $gpu_count -gt 0 ] && return 0 || return 1
}

# Get Intel GPU info
get_intel_info() {
    if command -v intel_gpu_top &> /dev/null; then
        # intel_gpu_top requires root and JSON parsing, so we'll use a simpler approach
        timeout 1 intel_gpu_top -J 2>/dev/null | head -20
        return 0
    fi
    
    # Basic info from sysfs
    local gpu_info=""
    for card in /sys/class/drm/card*/device; do
        if [ -f "$card/vendor" ]; then
            local vendor=$(cat "$card/vendor" 2>/dev/null)
            if [ "$vendor" = "0x8086" ]; then
                local name=$(lspci | grep -i vga | grep -i intel | head -1 | cut -d: -f3)
                echo "Intel GPU: $name"
                echo "  Use 'intel_gpu_top' for detailed monitoring"
                return 0
            fi
        fi
    done
    
    return 1
}

# Show GPU dashboard
show_gpu() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                      GPU MONITORING"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    local gpu_type=$(detect_gpu)
    
    case "$gpu_type" in
        nvidia)
            show_nvidia_gpu
            ;;
        amd)
            show_amd_gpu
            ;;
        intel)
            show_intel_gpu
            ;;
        none)
            print_warning "No supported GPU detected or drivers not installed"
            echo ""
            echo "Supported GPUs:"
            echo "  • NVIDIA (requires nvidia-smi)"
            echo "  • AMD (requires rocm-smi or sysfs access)"
            echo "  • Intel (basic support via sysfs)"
            echo ""
            echo "Install instructions:"
            echo "  NVIDIA: Install NVIDIA drivers"
            echo "  AMD: Install ROCm (rocm-smi)"
            echo "  Intel: Install intel-gpu-tools"
            ;;
    esac
}

# Show NVIDIA GPU details
show_nvidia_gpu() {
    echo -e "${BOLD}${GREEN}NVIDIA GPU Detected${NC}"
    echo ""
    
    local gpu_data=$(get_nvidia_info)
    
    if [ -z "$gpu_data" ]; then
        print_error "Failed to get NVIDIA GPU information"
        return 1
    fi
    
    echo "$gpu_data" | while IFS=, read -r index name gpu_util mem_util mem_used mem_total temp power power_limit fan; do
        # Clean up values
        name=$(echo "$name" | xargs)
        gpu_util=$(echo "$gpu_util" | xargs)
        mem_util=$(echo "$mem_util" | xargs)
        mem_used=$(echo "$mem_used" | xargs)
        mem_total=$(echo "$mem_total" | xargs)
        temp=$(echo "$temp" | xargs)
        power=$(echo "$power" | xargs)
        power_limit=$(echo "$power_limit" | xargs)
        fan=$(echo "$fan" | xargs)
        
        echo -e "${CYAN}${BOLD}GPU $index: $name${NC}"
        echo ""
        
        # GPU Utilization
        local gpu_color=$(get_color ${gpu_util%.*})
        echo -e "${BOLD}GPU Utilization:${NC} ${gpu_color}${gpu_util}%${NC}"
        printf "["
        local bars=$((${gpu_util%.*} / 2))
        for i in $(seq 1 50); do
            if [ $i -le $bars ]; then
                printf "${gpu_color}█${NC}"
            else
                printf "░"
            fi
        done
        printf "]\n"
        echo ""
        
        # Memory Utilization
        local mem_color=$(get_color ${mem_util%.*})
        echo -e "${BOLD}Memory Utilization:${NC} ${mem_color}${mem_util}%${NC} (${mem_used}MB / ${mem_total}MB)"
        printf "["
        local bars=$((${mem_util%.*} / 2))
        for i in $(seq 1 50); do
            if [ $i -le $bars ]; then
                printf "${mem_color}█${NC}"
            else
                printf "░"
            fi
        done
        printf "]\n"
        echo ""
        
        # Temperature
        local temp_color=$(get_color ${temp%.*})
        echo -e "${BOLD}Temperature:${NC} ${temp_color}${temp}°C${NC}"
        echo ""
        
        # Power Draw
        if [ "$power" != "[N/A]" ] && [ -n "$power" ]; then
            local power_percent=$((${power%.*} * 100 / ${power_limit%.*}))
            local power_color=$(get_color $power_percent)
            echo -e "${BOLD}Power Draw:${NC} ${power_color}${power}W${NC} / ${power_limit}W (${power_percent}%)"
            echo ""
        fi
        
        # Fan Speed
        if [ "$fan" != "[N/A]" ] && [ -n "$fan" ]; then
            echo -e "${BOLD}Fan Speed:${NC} ${fan}%"
            echo ""
        fi
        
        echo "────────────────────────────────────────────────────────────────────"
        echo ""
    done
    
    # GPU Processes
    echo -e "${BOLD}GPU Processes:${NC}"
    echo ""
    
    local processes=$(nvidia-smi pmon -c 1 2>/dev/null | grep -v '^#' | tail -n +2)
    
    if [ -n "$processes" ]; then
        printf "${CYAN}%-8s %-8s %-8s %-10s %-10s %-30s${NC}\n" "GPU" "PID" "TYPE" "SM %" "MEM %" "NAME"
        echo "────────────────────────────────────────────────────────────────────"
        echo "$processes" | while read line; do
            if [ -n "$line" ]; then
                echo "$line" | awk '{printf "%-8s %-8s %-8s %-10s %-10s %-30s\n", $1, $2, $3, $4"%", $5"%", substr($6,1,30)}'
            fi
        done
    else
        echo "  No active GPU processes"
    fi
    
    echo ""
}

# Show AMD GPU details
show_amd_gpu() {
    echo -e "${BOLD}${RED}AMD GPU Detected${NC}"
    echo ""
    
    if ! get_amd_info; then
        print_warning "Limited AMD GPU information available"
        echo ""
        echo "For full monitoring, install ROCm:"
        echo "  https://rocm.docs.amd.com/"
        echo ""
    fi
}

# Show Intel GPU details
show_intel_gpu() {
    echo -e "${BOLD}${BLUE}Intel GPU Detected${NC}"
    echo ""
    
    if ! get_intel_info; then
        local gpu_name=$(lspci | grep -i vga | grep -i intel | head -1 | cut -d: -f3)
        echo "GPU: $gpu_name"
        echo ""
        print_warning "Limited Intel GPU information available"
        echo ""
        echo "For detailed monitoring, install intel-gpu-tools:"
        echo "  sudo apt install intel-gpu-tools    # Ubuntu/Debian"
        echo "  sudo dnf install intel-gpu-tools    # Fedora"
        echo ""
        echo "Then run with sudo: sudo intel_gpu_top"
    fi
    
    echo ""
}

# Show dashboard
show_dashboard() {
    clear
    
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                      SYSTEM MONITOR"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    # System info
    echo -e "${CYAN}System:${NC} $(hostname) | ${CYAN}Uptime:${NC} $(get_uptime)"
    echo -e "${CYAN}Kernel:${NC} $(uname -r)"
    echo ""
    
    # CPU
    local cpu_usage=$(get_cpu_usage | cut -d. -f1)
    local cpu_color=$(get_color $cpu_usage)
    echo -e "${BOLD}CPU Usage:${NC} ${cpu_color}${cpu_usage}%${NC}"
    printf "["
    local bars=$((cpu_usage / 2))
    for i in $(seq 1 50); do
        if [ $i -le $bars ]; then
            printf "${cpu_color}█${NC}"
        else
            printf "░"
        fi
    done
    printf "]\n"
    echo ""
    
    # Memory
    local mem_usage=$(get_memory_usage)
    local mem_details=$(get_memory_details)
    local mem_color=$(get_color $mem_usage)
    echo -e "${BOLD}Memory Usage:${NC} ${mem_color}${mem_usage}%${NC} (${mem_details})"
    printf "["
    local bars=$((mem_usage / 2))
    for i in $(seq 1 50); do
        if [ $i -le $bars ]; then
            printf "${mem_color}█${NC}"
        else
            printf "░"
        fi
    done
    printf "]\n"
    echo ""
    
    # Disk
    local disk_usage=$(get_disk_usage)
    local disk_details=$(get_disk_details)
    local disk_color=$(get_color $disk_usage)
    echo -e "${BOLD}Disk Usage:${NC} ${disk_color}${disk_usage}%${NC} (${disk_details})"
    printf "["
    local bars=$((disk_usage / 2))
    for i in $(seq 1 50); do
        if [ $i -le $bars ]; then
            printf "${disk_color}█${NC}"
        else
            printf "░"
        fi
    done
    printf "]\n"
    echo ""
    
    # Load average
    echo -e "${BOLD}Load Average:${NC} $(get_load_average)"
    echo ""
    
    # GPU info (if available)
    local gpu_type=$(detect_gpu)
    if [ "$gpu_type" != "none" ]; then
        case "$gpu_type" in
            nvidia)
                local gpu_util=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -1 | xargs)
                local gpu_temp=$(nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader,nounits 2>/dev/null | head -1 | xargs)
                local gpu_name=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -1)
                
                if [ -n "$gpu_util" ]; then
                    local gpu_color=$(get_color ${gpu_util%.*})
                    echo -e "${BOLD}GPU (${gpu_name}):${NC} ${gpu_color}${gpu_util}%${NC} | ${gpu_temp}°C"
                    echo ""
                fi
                ;;
            amd|intel)
                echo -e "${BOLD}GPU:${NC} ${gpu_type^^} detected (use 'sysmon gpu' for details)"
                echo ""
                ;;
        esac
    fi
    
    # Top processes
    print_header "TOP PROCESSES (by CPU)"
    echo ""
    printf "${CYAN}%-8s %-20s %-8s %-8s %-30s${NC}\n" "PID" "USER" "CPU%" "MEM%" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    ps aux --sort=-%cpu | head -11 | tail -10 | awk '{printf "%-8s %-20s %-8s %-8s %-30s\n", $2, substr($1,1,20), $3"%", $4"%", substr($11,1,30)}'
    echo ""
    
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    print_info "Commands: sysmon process | sysmon gpu | sysmon network | sysmon disk | sysmon top"
    echo ""
}

# Show all processes
show_processes() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                        PROCESSES"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    printf "${CYAN}%-8s %-15s %-8s %-8s %-10s %-30s${NC}\n" "PID" "USER" "CPU%" "MEM%" "STATE" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    
    ps aux | tail -n +2 | while read line; do
        local pid=$(echo "$line" | awk '{print $2}')
        local user=$(echo "$line" | awk '{print substr($1,1,15)}')
        local cpu=$(echo "$line" | awk '{print $3}')
        local mem=$(echo "$line" | awk '{print $4}')
        local state=$(echo "$line" | awk '{print $8}')
        local cmd=$(echo "$line" | awk '{print substr($11,1,30)}')
        
        printf "%-8s %-15s %-8s %-8s %-10s %-30s\n" "$pid" "$user" "${cpu}%" "${mem}%" "$state" "$cmd"
    done | head -50
    
    echo ""
    print_info "Total processes: $(ps aux | wc -l)"
}

# Show top consumers
show_top() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                   TOP RESOURCE CONSUMERS"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    echo -e "${BOLD}Top CPU Consumers:${NC}"
    printf "${CYAN}%-8s %-20s %-8s %-30s${NC}\n" "PID" "USER" "CPU%" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    ps aux --sort=-%cpu | head -11 | tail -10 | awk '{printf "%-8s %-20s %-8s %-30s\n", $2, substr($1,1,20), $3"%", substr($11,1,30)}'
    echo ""
    
    echo -e "${BOLD}Top Memory Consumers:${NC}"
    printf "${CYAN}%-8s %-20s %-8s %-30s${NC}\n" "PID" "USER" "MEM%" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    ps aux --sort=-%mem | head -11 | tail -10 | awk '{printf "%-8s %-20s %-8s %-30s\n", $2, substr($1,1,20), $4"%", substr($11,1,30)}'
    echo ""
}

# Show network
show_network() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                     NETWORK ACTIVITY"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    # Network interfaces
    echo -e "${BOLD}Network Interfaces:${NC}"
    ip -s link | grep -E '^[0-9]+:' -A 5 | grep -E '(^[0-9]+:|RX:|TX:)' | sed 's/^[[:space:]]*//'
    echo ""
    
    # Active connections
    echo -e "${BOLD}Active Connections:${NC}"
    printf "${CYAN}%-25s %-25s %-15s %-15s${NC}\n" "LOCAL" "REMOTE" "STATE" "PROGRAM"
    echo "────────────────────────────────────────────────────────────────────"
    
    if command -v ss &> /dev/null; then
        ss -tupn 2>/dev/null | grep ESTAB | head -20 | awk '{print $5, $6, $1}' | while read local remote state; do
            printf "%-25s %-25s %-15s\n" "${local:0:25}" "${remote:0:25}" "${state:0:15}"
        done
    else
        netstat -tupn 2>/dev/null | grep ESTABLISHED | head -20 | awk '{print $4, $5, $6}' | while read local remote state; do
            printf "%-25s %-25s %-15s\n" "${local:0:25}" "${remote:0:25}" "${state:0:15}"
        done
    fi
    
    echo ""
    print_info "Total connections: $(ss -tupn 2>/dev/null | grep -c ESTAB || netstat -tupn 2>/dev/null | grep -c ESTABLISHED)"
}

# Show disk I/O
show_disk() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                      DISK USAGE & I/O"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    echo -e "${BOLD}Filesystem Usage:${NC}"
    df -h | grep -v tmpfs | grep -v devtmpfs
    echo ""
    
    if command -v iostat &> /dev/null; then
        echo -e "${BOLD}Disk I/O Statistics:${NC}"
        iostat -x 1 2 | tail -n +4
    else
        print_warning "Install sysstat for detailed I/O stats: sudo apt install sysstat"
    fi
    
    echo ""
}

# Kill process
kill_process() {
    local pid="$1"
    
    if [ -z "$pid" ]; then
        print_error "Please specify a PID"
        return 1
    fi
    
    if ! ps -p "$pid" > /dev/null 2>&1; then
        print_error "Process $pid not found"
        return 1
    fi
    
    local cmd=$(ps -p "$pid" -o cmd= 2>/dev/null)
    
    print_warning "About to kill:"
    echo "  PID:     $pid"
    echo "  Command: $cmd"
    echo ""
    
    read -p "Continue? (y/N) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        kill "$pid" 2>/dev/null && sleep 1
        
        if ps -p "$pid" > /dev/null 2>&1; then
            print_warning "Process still alive, force killing..."
            kill -9 "$pid" 2>/dev/null
        fi
        
        print_success "Process $pid killed"
    else
        print_info "Cancelled"
    fi
}

# Watch mode
watch_mode() {
    print_info "Starting live monitoring... (Ctrl+C to exit)"
    echo ""
    
    while true; do
        show_dashboard
        sleep 2
    done
}

# Main
if [ $# -eq 0 ]; then
    show_dashboard
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    process|processes|ps)
        show_processes
        ;;
    top)
        show_top
        ;;
    network|net)
        show_network
        ;;
    disk|df)
        show_disk
        ;;
    gpu)
        show_gpu
        ;;
    kill)
        kill_process "$@"
        ;;
    watch|live)
        watch_mode
        ;;
    -h|--help)
        show_usage
        ;;
    -v|--version)
        show_version
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo "Use -h or --help for usage information"
        exit 1
        ;;
esac
