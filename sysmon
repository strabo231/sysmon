#!/bin/bash

# SysMon - System Resource Monitor
# Version: 1.0.0

VERSION="1.0.0"
SCRIPT_NAME="sysmon"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_header() { echo -e "${CYAN}${BOLD}${1}${NC}"; }

show_usage() {
    cat << EOF
${BLUE}${BOLD}SysMon${NC} - System Resource Monitor v${VERSION}

${YELLOW}Usage:${NC}
    $SCRIPT_NAME [command] [options]

${YELLOW}Commands:${NC}
    (no command)             Dashboard view (default)
    process                  List all processes
    top                      Top resource consumers
    network                  Network connections
    disk                     Disk I/O and usage
    kill <pid>               Kill a process
    watch                    Live monitoring mode

${YELLOW}Options:${NC}
    -h, --help              Show this help
    -v, --version           Show version
    --no-color              Disable colors

${YELLOW}Examples:${NC}
    $SCRIPT_NAME
        → Show system dashboard

    $SCRIPT_NAME process
        → List all processes

    $SCRIPT_NAME top
        → Show top consumers

    $SCRIPT_NAME network
        → Show network activity

    $SCRIPT_NAME kill 1234
        → Kill process 1234

${YELLOW}Dashboard:${NC}
    Shows at a glance:
    • CPU usage
    • Memory usage
    • Disk usage
    • Network activity
    • Top processes
    • System load

EOF
}

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Get color based on percentage
get_color() {
    local percent=$1
    if [ "$percent" -ge 90 ]; then
        echo "$RED"
    elif [ "$percent" -ge 70 ]; then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

# Format bytes
format_bytes() {
    local bytes=$1
    if [ "$bytes" -lt 1024 ]; then
        echo "${bytes}B"
    elif [ "$bytes" -lt 1048576 ]; then
        echo "$((bytes / 1024))KB"
    elif [ "$bytes" -lt 1073741824 ]; then
        echo "$((bytes / 1048576))MB"
    else
        echo "$((bytes / 1073741824))GB"
    fi
}

# Get CPU usage
get_cpu_usage() {
    if command -v mpstat &> /dev/null; then
        mpstat 1 1 | awk '/Average/ {print 100 - $NF}'
    else
        top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}'
    fi
}

# Get memory usage
get_memory_usage() {
    free | grep Mem | awk '{printf "%.0f", ($3/$2) * 100.0}'
}

# Get memory details
get_memory_details() {
    free -h | grep Mem | awk '{print $3 "/" $2}'
}

# Get disk usage
get_disk_usage() {
    df -h / | awk 'NR==2 {print $5}' | sed 's/%//'
}

# Get disk details
get_disk_details() {
    df -h / | awk 'NR==2 {print $3 "/" $2}'
}

# Get system load
get_load_average() {
    uptime | awk -F'load average:' '{print $2}' | sed 's/^[ \t]*//'
}

# Get uptime
get_uptime() {
    uptime -p 2>/dev/null || uptime | awk -F'up ' '{print $2}' | awk -F',' '{print $1}'
}

# Show dashboard
show_dashboard() {
    clear
    
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                      SYSTEM MONITOR"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    # System info
    echo -e "${CYAN}System:${NC} $(hostname) | ${CYAN}Uptime:${NC} $(get_uptime)"
    echo -e "${CYAN}Kernel:${NC} $(uname -r)"
    echo ""
    
    # CPU
    local cpu_usage=$(get_cpu_usage | cut -d. -f1)
    local cpu_color=$(get_color $cpu_usage)
    echo -e "${BOLD}CPU Usage:${NC} ${cpu_color}${cpu_usage}%${NC}"
    printf "["
    local bars=$((cpu_usage / 2))
    for i in $(seq 1 50); do
        if [ $i -le $bars ]; then
            printf "${cpu_color}█${NC}"
        else
            printf "░"
        fi
    done
    printf "]\n"
    echo ""
    
    # Memory
    local mem_usage=$(get_memory_usage)
    local mem_details=$(get_memory_details)
    local mem_color=$(get_color $mem_usage)
    echo -e "${BOLD}Memory Usage:${NC} ${mem_color}${mem_usage}%${NC} (${mem_details})"
    printf "["
    local bars=$((mem_usage / 2))
    for i in $(seq 1 50); do
        if [ $i -le $bars ]; then
            printf "${mem_color}█${NC}"
        else
            printf "░"
        fi
    done
    printf "]\n"
    echo ""
    
    # Disk
    local disk_usage=$(get_disk_usage)
    local disk_details=$(get_disk_details)
    local disk_color=$(get_color $disk_usage)
    echo -e "${BOLD}Disk Usage:${NC} ${disk_color}${disk_usage}%${NC} (${disk_details})"
    printf "["
    local bars=$((disk_usage / 2))
    for i in $(seq 1 50); do
        if [ $i -le $bars ]; then
            printf "${disk_color}█${NC}"
        else
            printf "░"
        fi
    done
    printf "]\n"
    echo ""
    
    # Load average
    echo -e "${BOLD}Load Average:${NC} $(get_load_average)"
    echo ""
    
    # Top processes
    print_header "TOP PROCESSES (by CPU)"
    echo ""
    printf "${CYAN}%-8s %-20s %-8s %-8s %-30s${NC}\n" "PID" "USER" "CPU%" "MEM%" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    ps aux --sort=-%cpu | head -11 | tail -10 | awk '{printf "%-8s %-20s %-8s %-8s %-30s\n", $2, substr($1,1,20), $3"%", $4"%", substr($11,1,30)}'
    echo ""
    
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    print_info "Commands: sysmon process | sysmon network | sysmon disk | sysmon top"
    echo ""
}

# Show all processes
show_processes() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                        PROCESSES"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    printf "${CYAN}%-8s %-15s %-8s %-8s %-10s %-30s${NC}\n" "PID" "USER" "CPU%" "MEM%" "STATE" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    
    ps aux | tail -n +2 | while read line; do
        local pid=$(echo "$line" | awk '{print $2}')
        local user=$(echo "$line" | awk '{print substr($1,1,15)}')
        local cpu=$(echo "$line" | awk '{print $3}')
        local mem=$(echo "$line" | awk '{print $4}')
        local state=$(echo "$line" | awk '{print $8}')
        local cmd=$(echo "$line" | awk '{print substr($11,1,30)}')
        
        printf "%-8s %-15s %-8s %-8s %-10s %-30s\n" "$pid" "$user" "${cpu}%" "${mem}%" "$state" "$cmd"
    done | head -50
    
    echo ""
    print_info "Total processes: $(ps aux | wc -l)"
}

# Show top consumers
show_top() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                   TOP RESOURCE CONSUMERS"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    echo -e "${BOLD}Top CPU Consumers:${NC}"
    printf "${CYAN}%-8s %-20s %-8s %-30s${NC}\n" "PID" "USER" "CPU%" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    ps aux --sort=-%cpu | head -11 | tail -10 | awk '{printf "%-8s %-20s %-8s %-30s\n", $2, substr($1,1,20), $3"%", substr($11,1,30)}'
    echo ""
    
    echo -e "${BOLD}Top Memory Consumers:${NC}"
    printf "${CYAN}%-8s %-20s %-8s %-30s${NC}\n" "PID" "USER" "MEM%" "COMMAND"
    echo "────────────────────────────────────────────────────────────────────"
    ps aux --sort=-%mem | head -11 | tail -10 | awk '{printf "%-8s %-20s %-8s %-30s\n", $2, substr($1,1,20), $4"%", substr($11,1,30)}'
    echo ""
}

# Show network
show_network() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                     NETWORK ACTIVITY"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    # Network interfaces
    echo -e "${BOLD}Network Interfaces:${NC}"
    ip -s link | grep -E '^[0-9]+:' -A 5 | grep -E '(^[0-9]+:|RX:|TX:)' | sed 's/^[[:space:]]*//'
    echo ""
    
    # Active connections
    echo -e "${BOLD}Active Connections:${NC}"
    printf "${CYAN}%-25s %-25s %-15s %-15s${NC}\n" "LOCAL" "REMOTE" "STATE" "PROGRAM"
    echo "────────────────────────────────────────────────────────────────────"
    
    if command -v ss &> /dev/null; then
        ss -tupn 2>/dev/null | grep ESTAB | head -20 | awk '{print $5, $6, $1}' | while read local remote state; do
            printf "%-25s %-25s %-15s\n" "${local:0:25}" "${remote:0:25}" "${state:0:15}"
        done
    else
        netstat -tupn 2>/dev/null | grep ESTABLISHED | head -20 | awk '{print $4, $5, $6}' | while read local remote state; do
            printf "%-25s %-25s %-15s\n" "${local:0:25}" "${remote:0:25}" "${state:0:15}"
        done
    fi
    
    echo ""
    print_info "Total connections: $(ss -tupn 2>/dev/null | grep -c ESTAB || netstat -tupn 2>/dev/null | grep -c ESTABLISHED)"
}

# Show disk I/O
show_disk() {
    print_header "═══════════════════════════════════════════════════════════════"
    print_header "                      DISK USAGE & I/O"
    print_header "═══════════════════════════════════════════════════════════════"
    echo ""
    
    echo -e "${BOLD}Filesystem Usage:${NC}"
    df -h | grep -v tmpfs | grep -v devtmpfs
    echo ""
    
    if command -v iostat &> /dev/null; then
        echo -e "${BOLD}Disk I/O Statistics:${NC}"
        iostat -x 1 2 | tail -n +4
    else
        print_warning "Install sysstat for detailed I/O stats: sudo apt install sysstat"
    fi
    
    echo ""
}

# Kill process
kill_process() {
    local pid="$1"
    
    if [ -z "$pid" ]; then
        print_error "Please specify a PID"
        return 1
    fi
    
    if ! ps -p "$pid" > /dev/null 2>&1; then
        print_error "Process $pid not found"
        return 1
    fi
    
    local cmd=$(ps -p "$pid" -o cmd= 2>/dev/null)
    
    print_warning "About to kill:"
    echo "  PID:     $pid"
    echo "  Command: $cmd"
    echo ""
    
    read -p "Continue? (y/N) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        kill "$pid" 2>/dev/null && sleep 1
        
        if ps -p "$pid" > /dev/null 2>&1; then
            print_warning "Process still alive, force killing..."
            kill -9 "$pid" 2>/dev/null
        fi
        
        print_success "Process $pid killed"
    else
        print_info "Cancelled"
    fi
}

# Watch mode
watch_mode() {
    print_info "Starting live monitoring... (Ctrl+C to exit)"
    echo ""
    
    while true; do
        show_dashboard
        sleep 2
    done
}

# Main
if [ $# -eq 0 ]; then
    show_dashboard
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    process|processes|ps)
        show_processes
        ;;
    top)
        show_top
        ;;
    network|net)
        show_network
        ;;
    disk|df)
        show_disk
        ;;
    kill)
        kill_process "$@"
        ;;
    watch|live)
        watch_mode
        ;;
    -h|--help)
        show_usage
        ;;
    -v|--version)
        show_version
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo "Use -h or --help for usage information"
        exit 1
        ;;
esac
